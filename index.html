<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –î–µ–π—Å—Ç–≤–∏–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #e0e0e0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #16213e; /* –ß—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
            text-align: center;
            border: 1px solid #0f3460;
        }
        .btn {
            background-color: #e94560; /* –Ø—Ä–∫–∏–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            width: 100%;
            display: block;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(233, 69, 96, 0.4);
            border: none;
        }
        .btn:hover {
            background-color: #b8364e;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background-color: #0f3460; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
            color: white;
            box-shadow: 0 4px 10px rgba(15, 52, 96, 0.4);
        }
        .btn-secondary:hover {
            background-color: #0c2a4f;
        }
        .btn-primary {
            background-color: #e94560;
        }
        .btn-primary:hover {
            background-color: #b8364e;
        }
        .text-gradient {
            background: linear-gradient(45deg, #e94560, #ff7e5f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #16213e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid #0f3460;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e94560;
        }
        .modal-body {
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .modal-actions button {
            margin: 5px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ index.html */
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .card {
            background-color: #0f1a2e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.1rem;
            line-height: 1.5;
            font-weight: 500;
            color: #e0e0e0;
        }
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: #0f3460;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .category-item:hover {
            background-color: #0c2a4f;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        .category-item.selected {
            background-color: #e94560;
            border: 2px solid #ff7e5f;
            box-shadow: 0 4px 10px rgba(233, 69, 96, 0.4);
            transform: translateY(-2px);
        }
        .ad-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #0f3460;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .ad-container img, .ad-container video {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        .ad-container a {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            color: #ff7e5f;
            text-decoration: none;
        }
        .ad-container a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        </div>

    <script>
        // URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô –î–û–ú–ï–ù –° HTTPS!
        const BACKEND_URL = 'https://mygameapi.ru'; 

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            window.Telegram.WebApp.MainButton.setText('–ù–∞—á–∞—Ç—å –∏–≥—Ä—É');
            window.Telegram.WebApp.MainButton.onClick(handleMainButtonClick);
            window.Telegram.WebApp.onEvent('themeChanged', () => {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã Telegram (—Å–≤–µ—Ç–ª–∞—è/—Ç–µ–º–Ω–∞—è)
                // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª–∏, –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–µ–º—ã
                console.log('–¢–µ–º–∞ Telegram –∏–∑–º–µ–Ω–µ–Ω–∞:', window.Telegram.WebApp.themeParams);
            });
            window.Telegram.WebApp.onEvent('viewportChanged', () => {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤—å—é–ø–æ—Ä—Ç–∞
                console.log('–†–∞–∑–º–µ—Ä –≤—å—é–ø–æ—Ä—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω:', window.Telegram.WebApp.viewportHeight, window.Telegram.WebApp.viewportStableHeight);
            });
            window.Telegram.WebApp.MainButton.show(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram
        } else {
            console.warn('Telegram Web App SDK –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram.');
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram –º–æ–∂–Ω–æ —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            window.Telegram = {
                WebApp: {
                    ready: () => console.log('WebApp Ready (Simulated)'),
                    expand: () => console.log('WebApp Expanded (Simulated)'),
                    MainButton: {
                        setText: (text) => console.log('MainButton Text (Simulated):', text),
                        onClick: (callback) => {
                            document.getElementById('simulated-main-button')?.removeEventListener('click', window.simulatedMainButtonHandler);
                            window.simulatedMainButtonHandler = callback;
                            const btn = document.createElement('button');
                            btn.id = 'simulated-main-button';
                            btn.className = 'btn btn-primary w-full mt-4';
                            btn.textContent = text;
                            btn.onclick = callback;
                            document.getElementById('app').appendChild(btn);
                        },
                        show: () => console.log('MainButton Show (Simulated)'),
                        hide: () => {
                            console.log('MainButton Hide (Simulated)');
                            document.getElementById('simulated-main-button')?.remove();
                        },
                        showProgress: () => console.log('MainButton Show Progress (Simulated)'),
                        hideProgress: () => console.log('MainButton Hide Progress (Simulated)'),
                    },
                    initDataUnsafe: {
                        user: { id: 'test_user_123', first_name: '–¢–µ—Å—Ç', last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }
                    },
                    showPopup: (params, callback) => {
                        alert(params.message); // –î–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –≤–Ω–µ Telegram
                        if (callback) callback();
                    },
                    openTelegramLink: (url) => window.open(url, '_blank'),
                }
            };
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.MainButton.setText('–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (–°–∏–º—É–ª—è—Ü–∏—è)');
            window.Telegram.WebApp.MainButton.onClick(handleMainButtonClick);
            window.Telegram.WebApp.MainButton.show();
        }

        let currentPage = 'ageGate';
        let gameMode = 'userChoice'; // 'userChoice' –∏–ª–∏ 'random'
        let selectedCategories = [];
        let allTasks = []; // –í—Å–µ –∑–∞–¥–∞–Ω–∏—è, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞
        let availableTasksForSession = []; // –ó–∞–¥–∞–Ω–∏—è, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ª–æ–≤–∞–º
        let playedTasksIdsInSession = []; // ID –∑–∞–¥–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ —Å—ã–≥—Ä–∞–Ω—ã –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
        let currentTask = null;
        let premiumStatus = false; // –°—Ç–∞—Ç—É—Å –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∏
        let currentPremiumPrice = 100; // –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å –±—ç–∫–µ–Ω–¥–∞

        let safeWords = []; // –°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∑–∞–¥–∞–Ω–∏—è—Ö

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ---

        function renderPage(pageName) {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }

            switch (pageName) {
                case 'ageGate':
                    renderAgeGate();
                    break;
                case 'welcome':
                    renderWelcomeScreen();
                    break;
                case 'gameModeSelection':
                    renderGameModeSelection();
                    break;
                case 'categorySelection':
                    renderCategorySelection();
                    break;
                case 'game':
                    renderGameScreen();
                    break;
                case 'settings':
                    renderSettings();
                    break;
                default:
                    renderAgeGate(); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
            currentPage = pageName;
        }

        function showModal(title, message, buttons = []) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal';
            modalOverlay.id = 'app-modal';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => modalOverlay.remove();
            modalContent.appendChild(closeBtn);

            const modalTitle = document.createElement('h3');
            modalTitle.className = 'text-2xl font-bold mb-4 text-gradient'; /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            modalTitle.textContent = title;
            modalContent.appendChild(modalTitle);

            const modalMessage = document.createElement('p');
            modalMessage.className = 'text-gray-300 mb-6 text-lg'; /* –ö—Ä—É–ø–Ω–µ–µ —Ç–µ–∫—Å—Ç */
            modalMessage.innerHTML = message;
            modalContent.appendChild(modalMessage);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-col gap-3';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `btn ${btnInfo.className || 'btn-secondary'} w-full`;
                button.onclick = () => {
                    modalOverlay.remove();
                    if (btnInfo.handler) btnInfo.handler();
                };
                buttonContainer.appendChild(button);
            });
            modalContent.appendChild(buttonContainer);

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü ---

        function renderAgeGate() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gradient">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ "–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –î–µ–π—Å—Ç–≤–∏–µ" –¥–ª—è –ø–∞—Ä!</h2>
                <p class="text-gray-300 mb-6">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç 18+. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤–∞–º –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç.</p>
                <div class="flex items-center mb-6">
                    <input type="checkbox" id="ageConfirm" class="form-checkbox h-5 w-5 text-purple-600 rounded-md">
                    <label for="ageConfirm" class="ml-2 text-gray-300 text-sm">–Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ –º–Ω–µ 18 –ª–µ—Ç –∏–ª–∏ –±–æ–ª–µ–µ, –∏ —è —Å–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) —Å <a href="#" id="termsLink" class="text-purple-400 hover:underline">–£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> –∏ <a href="#" id="privacyLink" class="text-purple-400 hover:underline">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.</label>
                </div>
                <button id="confirmAgeBtn" class="btn btn-primary w-full opacity-50 cursor-not-allowed" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            `;

            const ageConfirmCheckbox = document.getElementById('ageConfirm');
            const confirmAgeBtn = document.getElementById('confirmAgeBtn');
            const termsLink = document.getElementById('termsLink');
            const privacyLink = document.getElementById('privacyLink');

            ageConfirmCheckbox.addEventListener('change', () => {
                confirmAgeBtn.disabled = !ageConfirmCheckbox.checked;
                confirmAgeBtn.classList.toggle('opacity-50', !ageConfirmCheckbox.checked);
                confirmAgeBtn.classList.toggle('cursor-not-allowed', !confirmAgeBtn.disabled);
            });

            confirmAgeBtn.addEventListener('click', () => {
                if (ageConfirmCheckbox.checked) {
                    localStorage.setItem('ageConfirmed', 'true');
                    renderPage('welcome');
                } else {
                    showModal('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∏ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏.');
                }
            });

            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', `
                    <p class="mb-3">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø–∞—Ä" –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (18+).</p>
                    <p class="mb-3">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –æ–±–æ—é–¥–Ω–æ–º—É —Å–æ–≥–ª–∞—Å–∏—é –æ–±–æ–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
                    <p class="mb-3">–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ—Ç—Å–∫–æ–π –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏–∏, –Ω–∞—Å–∏–ª–∏—è).</p>
                    <p>–ú—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã, –Ω–∞—Ä—É—à–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.</p>
                `);
            });

            privacyLink.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏', `
                    <p class="mb-3">–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫–∏–µ –∫–∞–∫ –∏–º–µ–Ω–∞, –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
                    <p class="mb-3">–ú—ã –º–æ–∂–µ–º —Å–æ–±–∏—Ä–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö —Ä–∞—É–Ω–¥–æ–≤, –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π) –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.</p>
                    <p class="mb-3">–í—Å–µ –∏–Ω—Ç–∏–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–≤–æ–¥–∏—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞), —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞ –Ω–∞—à–∏ —Å–µ—Ä–≤–µ—Ä—ã.</p>
                    <p>–ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Telegram Stars –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è Telegram –∏ TON, –º—ã –Ω–µ –ø–æ–ª—É—á–∞–µ–º –∏ –Ω–µ —Ö—Ä–∞–Ω–∏–º –≤–∞—à—É –ø–ª–∞—Ç–µ–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
                `);
            });
        }

        function renderWelcomeScreen() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-gradient">–ü—Ä–∏–≤–µ—Ç! ‚ú®</h2>
                <p class="text-gray-300 mb-6 text-lg">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ "–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –î–µ–π—Å—Ç–≤–∏–µ" ‚Äì –∏–¥–µ–∞–ª—å–Ω—É—é –∏–≥—Ä—É –¥–ª—è —Å–±–ª–∏–∂–µ–Ω–∏—è —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º.</p>
                <button id="startGameBtn" class="btn btn-primary w-full">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É</button>
                <button id="settingsBtn" class="btn btn-secondary w-full">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            `;
            document.getElementById('startGameBtn').addEventListener('click', () => renderPage('gameModeSelection'));
            document.getElementById('settingsBtn').addEventListener('click', () => renderPage('settings'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide(); // –ù–∞ —ç—Ç–æ–º —ç–∫—Ä–∞–Ω–µ –≥–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
            }
        }

        function renderGameModeSelection() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gradient">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã</h2>
                <p class="text-gray-300 mb-6">–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–≥—Ä–∞—Ç—å?</p>
                <button id="userChoiceModeBtn" class="btn ${gameMode === 'userChoice' ? 'btn-primary' : 'btn-secondary'} w-full mb-3">
                    –ù–∞—à –í—ã–±–æ—Ä (–í—ã —Å–∞–º–∏ –≤—ã–±–∏—Ä–∞–µ—Ç–µ "–ü—Ä–∞–≤–¥—É" –∏–ª–∏ "–î–µ–π—Å—Ç–≤–∏–µ")
                </button>
                <button id="randomModeBtn" class="btn ${gameMode === 'random' ? 'btn-primary' : 'btn-secondary'} w-full mb-6">
                    –°—é—Ä–ø—Ä–∏–∑ (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º)
                </button>
                <button id="confirmModeBtn" class="btn btn-primary w-full">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button id="backFromGameModeBtn" class="btn btn-secondary w-full mt-4">–ù–∞–∑–∞–¥</button>
            `;

            document.getElementById('userChoiceModeBtn').addEventListener('click', () => {
                gameMode = 'userChoice';
                renderGameModeSelection(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
            });
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                gameMode = 'random';
                renderGameModeSelection(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
            });
            document.getElementById('confirmModeBtn').addEventListener('click', () => renderPage('categorySelection'));
            document.getElementById('backFromGameModeBtn').addEventListener('click', () => renderPage('welcome'));
        }

        async function renderCategorySelection() {
            // –ü–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –æ–±–Ω–æ–≤–∏–º –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å
            await checkPremiumStatus(); 
            await fetchPremiumPriceForUser(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–µ

            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gradient">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–¥–∞–Ω–∏–π</h2>
                <p class="text-gray-300 mb-6">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ, —á—Ç–æ –≤–∞–º –ø–æ –¥—É—à–µ. –ü–ª–∞—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏.</p>
                <div id="categoriesList" class="flex flex-col gap-3 mb-6">
                    </div>
                <button id="startGameFromCategoriesBtn" class="btn btn-primary w-full">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                <button id="buyPremiumBtn" class="btn btn-secondary w-full mt-3">–ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º / ${currentPremiumPrice} Stars</button>
                <button id="backFromCategoryBtn" class="btn btn-secondary w-full mt-4">–ù–∞–∑–∞–¥</button>
            `;

            const categoriesList = document.getElementById('categoriesList');
            const buyPremiumBtn = document.getElementById('buyPremiumBtn'); // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–¥–µ—Å—å

            try {
                const response = await fetch(`${BACKEND_URL}/api/categories`);
                if (!response.ok) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const { categories: fetchedCategories } = await response.json();

                fetchedCategories.forEach(cat => {
                    const isSelected = selectedCategories.includes(cat.name);
                    const isPaid = cat.level === 'paid';
                    const isDisabled = isPaid && !premiumStatus;

                    const categoryItem = document.createElement('div');
                    categoryItem.className = `category-item ${isSelected ? 'selected' : ''} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                    categoryItem.innerHTML = `
                        <div class="text-left">
                            <p class="font-semibold text-white">${cat.name} ${isPaid ? '<span class="text-yellow-400 text-sm font-bold">üåü –ü—Ä–µ–º–∏—É–º</span>' : ''}</p>
                            <p class="text-sm text-gray-400">${cat.description}</p>
                        </div>
                        ${isDisabled ? '<span class="text-red-400 text-xl">üîí</span>' : '<input type="checkbox" class="form-checkbox h-5 w-5 text-purple-400 rounded-md" ' + (isSelected ? 'checked' : '') + '>'}
                    `;
                    if (!isDisabled) {
                        categoryItem.addEventListener('click', () => {
                            if (selectedCategories.includes(cat.name)) {
                                selectedCategories = selectedCategories.filter(name => name !== cat.name);
                            } else {
                                selectedCategories.push(cat.name);
                            }
                            renderCategorySelection(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
                        });
                    } else {
                        // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏
                        categoryItem.addEventListener('click', showPremiumPurchase);
                    }
                    categoriesList.appendChild(categoryItem);
                });
                // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                document.getElementById('categoryLoadError')?.remove(); 

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                if (!document.getElementById('categoryLoadError')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'categoryLoadError';
                    errorDiv.className = 'text-red-400 text-center mb-4';
                    errorDiv.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω.';
                    categoriesList.before(errorDiv); // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                }
            }

            document.getElementById('startGameFromCategoriesBtn').addEventListener('click', startGame);
            buyPremiumBtn.addEventListener('click', showPremiumPurchase); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
            document.getElementById('backFromCategoryBtn').addEventListener('click', () => renderPage('gameModeSelection'));

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            if (premiumStatus) {
                buyPremiumBtn.textContent = '–ü—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω!';
                buyPremiumBtn.disabled = true;
                buyPremiumBtn.classList.remove('btn-primary');
                buyPremiumBtn.classList.add('btn-secondary');
            } else {
                buyPremiumBtn.textContent = `–ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º / ${currentPremiumPrice} Stars`;
                buyPremiumBtn.disabled = false;
                buyPremiumBtn.classList.remove('btn-secondary');
                buyPremiumBtn.classList.add('btn-primary');
            }

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide();
            }
        }

        function renderGameScreen() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gradient">–í–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ:</h2>
                <div id="taskCard" class="card mb-6">–ù–∞–∂–º–∏—Ç–µ "–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ"</div>
                <div id="gameControls" class="flex flex-col gap-3">
                    ${gameMode === 'userChoice' ? `
                        <div class="flex gap-3">
                            <button id="chooseTruthBtn" class="btn btn-primary w-1/2">–ü—Ä–∞–≤–¥–∞</button>
                            <button id="chooseDareBtn" class="btn btn-primary w-1/2">–î–µ–π—Å—Ç–≤–∏–µ</button>
                        </div>
                    ` : ''}
                    <button id="nextTaskBtn" class="btn btn-primary w-full">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
                    <button id="skipTaskBtn" class="btn btn-secondary w-full">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                    <button id="backToCategoriesBtn" class="btn btn-secondary w-full mt-4">–°–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
                </div>
                <div id="adDisplay" class="ad-container hidden"></div>
            `;

            if (gameMode === 'userChoice') {
                document.getElementById('chooseTruthBtn').addEventListener('click', () => getNextTask('truth'));
                document.getElementById('chooseDareBtn').addEventListener('click', () => getNextTask('dare'));
            }
            document.getElementById('nextTaskBtn').addEventListener('click', () => getNextTask(gameMode === 'random' ? null : currentTask?.type));
            document.getElementById('skipTaskBtn').addEventListener('click', skipTask);
            document.getElementById('backToCategoriesBtn').addEventListener('click', () => renderPage('categorySelection'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide();
            }
            displayAd(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–ª–∞–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        }

        function renderSettings() {
            const appDiv = document.getElementById('app');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ localStorage
            const storedSafeWords = localStorage.getItem('safeWords');
            safeWords = storedSafeWords ? JSON.parse(storedSafeWords) : [];

            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gradient">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <div class="mb-6 text-left">
                    <h3 class="text-xl font-semibold mb-3 text-white">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞ / –ì—Ä–∞–Ω–∏—Ü—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞</h3>
                    <p class="text-gray-300 mb-2">–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ –∑–∞–¥–∞–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–µ–¥–∞", "–ø—É–±–ª–∏—á–Ω–æ", "–ë–î–°–ú"). –†–∞–∑–¥–µ–ª—è–π—Ç–µ –∑–∞–ø—è—Ç—ã–º–∏.</p>
                    <input type="text" id="safeWordsInput" class="w-full p-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-800 text-white" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –µ–¥–∞, –ø—É–±–ª–∏—á–Ω–æ">
                    <button id="saveSafeWordsBtn" class="btn btn-primary w-full mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞</button>
                    <p class="text-sm text-gray-400 mt-2">–¢–µ–∫—É—â–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞: <span id="currentSafeWords">${safeWords.join(', ') || '–ù–µ—Ç'}</span></p>
                </div>
                <button id="backToWelcomeBtn" class="btn btn-secondary w-full mt-4">–ù–∞–∑–∞–¥</button>
            `;

            const safeWordsInput = document.getElementById('safeWordsInput');
            safeWordsInput.value = safeWords.join(', ');

            document.getElementById('saveSafeWordsBtn').addEventListener('click', () => {
                const newSafeWords = safeWordsInput.value.split(',').map(s => s.trim().toLowerCase()).filter(s => s.length > 0);
                safeWords = newSafeWords;
                localStorage.setItem('safeWords', JSON.stringify(safeWords));
                document.getElementById('currentSafeWords').textContent = safeWords.join(', ') || '–ù–µ—Ç';
                showModal('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
            });

            document.getElementById('backToWelcomeBtn').addEventListener('click', () => renderPage('welcome'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide();
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---

        async function fetchTasksAndCategories() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.showProgress();
            }
            try {
                const tasksResponse = await fetch(`${BACKEND_URL}/api/tasks`);
                const { tasks: fetchedTasks } = await tasksResponse.json();
                allTasks = fetchedTasks; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è

                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ renderCategorySelection
                return true;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                // –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω.');
                return false;
            } finally {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                    window.Telegram.WebApp.MainButton.hideProgress();
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–º–∏—É–º–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
        async function fetchPremiumPriceForUser() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–∂–µ –µ—Å—Ç—å
                const response = await fetch(`${BACKEND_URL}/api/admin/settings/premium-price`);
                const data = await response.json();
                if (response.ok) {
                    currentPremiumPrice = parseInt(data.premiumPrice);
                    console.log('–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–µ–º–∏—É–º–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentPremiumPrice);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–º–∏—É–º–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data.message);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å –±—ç–∫–µ–Ω–¥–∞
                    currentPremiumPrice = 100;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–º–∏—É–º–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏
                currentPremiumPrice = 100;
            }
        }


        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkPremiumStatus() {
            const userId = window.Telegram.WebApp.initDataUnsafe.user?.id;
            if (!userId) {
                console.warn('User ID not available for premium status check.');
                premiumStatus = false;
                localStorage.setItem('premiumStatus', 'false');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/users/${userId}/premium`);
                if (response.ok) {
                    const data = await response.json();
                    premiumStatus = data.premium; // –¢–µ–ø–µ—Ä—å premium –±—É–¥–µ—Ç true —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    localStorage.setItem('premiumStatus', premiumStatus.toString()); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                    console.log(`Premium status for user ${userId}: ${premiumStatus}`);
                } else {
                    console.error('Failed to fetch premium status:', response.status);
                    premiumStatus = false;
                    localStorage.setItem('premiumStatus', 'false');
                }
            } catch (error) {
                console.error('Error checking premium status:', error);
                premiumStatus = false;
                localStorage.setItem('premiumStatus', 'false');
            }
        }

        async function startGame() {
            if (selectedCategories.length === 0) {
                showModal('–í–Ω–∏–º–∞–Ω–∏–µ', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∑–∞–¥–∞–Ω–∏–π.');
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
            availableTasksForSession = allTasks.filter(task => {
                const isCategorySelected = selectedCategories.includes(task.category);
                const isPremiumContent = task.level === 'paid';
                const isAllowedByPremium = !isPremiumContent || premiumStatus;
                return isCategorySelected && isAllowedByPremium;
            });

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ª–æ–≤–∞–º
            const storedSafeWords = localStorage.getItem('safeWords');
            safeWords = storedSafeWords ? JSON.parse(storedSafeWords) : [];
            availableTasksForSession = availableTasksForSession.filter(task => {
                const taskText = task.text.toLowerCase();
                return !safeWords.some(word => taskText.includes(word));
            });

            if (availableTasksForSession.length === 0) {
                showModal('–í–Ω–∏–º–∞–Ω–∏–µ', '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–ª–æ–≤.');
                renderPage('categorySelection'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                return;
            }

            playedTasksIdsInSession = []; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—ã–≥—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
            renderPage('game');
            getNextTask(gameMode === 'random' ? null : 'truth'); // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–ü—Ä–∞–≤–¥–∞" –µ—Å–ª–∏ —Ä–µ–∂–∏–º "–ù–∞—à –í—ã–±–æ—Ä"
        }

        function getNextTask(type = null) {
            const taskCard = document.getElementById('taskCard');
            taskCard.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            let filteredTasks = availableTasksForSession.filter(task => !playedTasksIdsInSession.includes(task.id));

            if (type) {
                filteredTasks = filteredTasks.filter(task => task.type === type);
            }

            if (filteredTasks.length === 0) {
                showModal('–ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞', '–í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö! –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É –∏–ª–∏ —Å–º–µ–Ω–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.', [
                    { text: '–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É', className: 'btn-primary', handler: () => renderPage('gameModeSelection') },
                    { text: '–°–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', className: 'btn-secondary', handler: () => renderPage('categorySelection') }
                ]);
                playedTasksIdsInSession = []; // –°–±—Ä–æ—Å –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                taskCard.textContent = '–ù–∞–∂–º–∏—Ç–µ "–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ"';
                currentTask = null;
                return;
            }

            const randomIndex = Math.floor(Math.random() * filteredTasks.length);
            currentTask = filteredTasks[randomIndex];

            taskCard.innerHTML = `<span class="font-bold text-gradient">${currentTask.type === 'truth' ? '–ü—Ä–∞–≤–¥–∞:' : '–î–µ–π—Å—Ç–≤–∏–µ:'}</span> ${currentTask.text}`;
            playedTasksIdsInSession.push(currentTask.id);

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏ (—Å–∏–º—É–ª—è—Ü–∏—è)
            sendAnalytics({
                event: 'task_completed',
                taskId: currentTask.id,
                category: currentTask.category,
                type: currentTask.type,
                userId: window.Telegram.WebApp.initDataUnsafe.user?.id || 'anonymous'
            });
            displayAd(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–ª–∞–º—É –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        }

        function skipTask() {
            if (!currentTask) {
                showModal('–í–Ω–∏–º–∞–Ω–∏–µ', '–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ, —á—Ç–æ–±—ã –µ–≥–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.');
                return;
            }
            showModal('–ó–∞–¥–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ', '–≠—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –±—ã–ª–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ. –ü–æ–ª—É—á–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ!', [
                { text: '–û–ö', className: 'btn-primary', handler: () => getNextTask(gameMode === 'random' ? null : currentTask?.type) }
            ]);
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ —á–µ—Ä–µ–∑ Telegram Stars
        async function initiateTelegramStarsPurchase() {
            if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe.user?.id) {
                showModal('–û—à–∏–±–∫–∞', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
                return;
            }

            const userId = window.Telegram.WebApp.initDataUnsafe.user.id;
            const item = 'premium_access';

            try {
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è invoice link
                const response = await fetch(`${BACKEND_URL}/api/purchase/initiate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, item }) // amount –±–µ—Ä–µ—Ç—Å—è —Å –±—ç–∫–µ–Ω–¥–∞
                });
                const result = await response.json();

                if (response.ok && result.invoice_url) {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Telegram
                    window.Telegram.WebApp.openInvoice(result.invoice_url, async (status) => {
                        if (status === 'paid') {
                            showModal('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ', '–ü—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É.');
                            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã, –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–º–∏—É–º–∞ —Å –±—ç–∫–µ–Ω–¥–∞
                            await checkPremiumStatus(); 
                            renderPage('categorySelection'); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                            sendAnalytics({
                                event: 'premium_purchased_stars',
                                userId: userId,
                                amount: currentPremiumPrice // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                            });
                        } else if (status === 'cancelled') {
                            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã
                            showModal('–ü–æ–∫—É–ø–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', '–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ –ø–æ–∫—É–ø–∫—É –ø—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø–∞. –í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∏ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –µ–≥–æ –ø–æ–∑–∂–µ!');
                        } else if (status === 'failed') {
                            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–∫–∏
                            showModal('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.');
                        } else {
                            showModal('–°—Ç–∞—Ç—É—Å –ø–æ–∫—É–ø–∫–∏', `–°—Ç–∞—Ç—É—Å: ${status}.`);
                        }
                    });
                } else {
                    showModal('–û—à–∏–±–∫–∞', result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É Stars. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏ Stars:', error);
                showModal('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        async function sendAnalytics(data) {
            try {
                await fetch(`${BACKEND_URL}/api/analytics`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
            }
        }

        let adCounter = 0;
        const AD_INTERVAL = 3; // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∫–ª–∞–º—É –∫–∞–∂–¥—ã–µ 3 –∑–∞–¥–∞–Ω–∏—è

        async function displayAd() {
            const adDisplayDiv = document.getElementById('adDisplay');
            adCounter++;

            if (premiumStatus) { // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–ª–∞–º—É –¥–ª—è –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                adDisplayDiv.classList.add('hidden');
                return;
            }

            if (adCounter % AD_INTERVAL === 0) {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/ads/current`);
                    if (response.ok) {
                        const adData = await response.json();
                        let mediaHtml = '';
                        if (adData.type === 'image') {
                            mediaHtml = `<img src="${adData.url}" alt="–†–µ–∫–ª–∞–º–∞" class="w-full h-auto object-cover">`;
                        } else if (adData.type === 'video') {
                            mediaHtml = `<video src="${adData.url}" controls class="w-full h-auto object-cover"></video>`;
                        }

                        adDisplayDiv.innerHTML = `
                            <p class="text-sm text-gray-400 mb-2">–†–µ–∫–ª–∞–º–∞</p>
                            ${mediaHtml}
                            <a href="${adData.link}" target="_blank" class="btn btn-secondary mt-3">
                                ${adData.text || '–ü–æ–¥—Ä–æ–±–Ω–µ–µ'}
                            </a>
                        `;
                        adDisplayDiv.classList.remove('hidden');
                    } else {
                        adDisplayDiv.classList.add('hidden'); // –°–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–ª–∞–º—ã:', error);
                    adDisplayDiv.classList.add('hidden');
                }
            } else {
                adDisplayDiv.classList.add('hidden');
            }
        }


        // --- –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram ---
        function handleMainButtonClick() {
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –ì–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram
            // –ï—ë –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (currentPage === 'welcome') {
                renderPage('gameModeSelection');
            } else if (currentPage === 'gameModeSelection') {
                renderPage('categorySelection');
            } else if (currentPage === 'categorySelection') {
                startGame();
            } else if (currentPage === 'game') {
                getNextTask(gameMode === 'random' ? null : currentTask?.type);
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        document.addEventListener('DOMContentLoaded', async () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –±—ç–∫–µ–Ω–¥–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            const dataLoaded = await fetchTasksAndCategories();
            if (!dataLoaded) {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –≤–æ–∑–º–æ–∂–Ω–æ, –±—ç–∫–µ–Ω–¥ –Ω–µ –∑–∞–ø—É—â–µ–Ω.
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É.
                // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (ageGate/welcome), —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É.
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
            const ageConfirmed = localStorage.getItem('ageConfirmed') === 'true';
            if (ageConfirmed) {
                // –ï—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å —Å –±—ç–∫–µ–Ω–¥–∞
                await checkPremiumStatus(); 
                renderPage('welcome');
            } else {
                renderPage('ageGate');
            }
        });
    </script>
</body>
</html>
