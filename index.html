<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игра для пар: Правда или Действие</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to right top, #f0f2f5, #e0e6eb); /* Мягкий градиент */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden; /* Предотвращаем горизонтальный скролл */
        }
        .container {
            width: 100%;
            max-width: 420px; /* Оптимизация для мобильных устройств */
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); /* Более выразительная тень */
            padding: 24px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 16px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            padding: 14px 28px; /* Немного больше padding */
            border-radius: 14px; /* Более скругленные углы */
            font-weight: 700; /* Более жирный шрифт */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Более плавный переход */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            text-transform: uppercase; /* Заглавные буквы */
            letter-spacing: 0.05em; /* Небольшой межбуквенный интервал */
        }
        .btn-primary {
            background-image: linear-gradient(to right top, #a78bfa, #8b5cf6); /* Фиолетовый градиент */
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right top, #9773f0, #7c4ee0);
            transform: translateY(-3px); /* Чуть больше подъем */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-secondary {
            background-color: #f0f4f8; /* Мягкий серый */
            color: #4a5568;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #e2e8f0;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .btn-green {
            background-image: linear-gradient(to right top, #68d391, #48bb78); /* Зеленый градиент */
            color: white;
            border: none;
        }
        .btn-green:hover {
            background-image: linear-gradient(to right top, #5bc282, #3da66b);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-red {
            background-image: linear-gradient(to right top, #fc8181, #e53e3e); /* Красный градиент */
            color: white;
            border: none;
        }
        .btn-red:hover {
            background-image: linear-gradient(to right top, #f27272, #d93030);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .card {
            background-color: #f7fafc;
            border-radius: 18px; /* Более скругленные */
            padding: 24px; /* Больше padding */
            box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.08); /* Более глубокая внутренняя тень */
            min-height: 150px; /* Увеличим высоту */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.25rem; /* text-xl */
            line-height: 1.8; /* leading-relaxed */
            font-weight: 600;
            color: #2d3748;
            animation: slideIn 0.6s ease-out; /* Анимация для карточки */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px; /* Больше padding */
            background-color: #f7fafc;
            border-radius: 14px; /* Более скругленные */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08); /* Более выразительная тень */
        }
        .category-item:hover {
            background-color: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.12);
        }
        .category-item.selected {
            background-color: #e0f2fe; /* light blue for selected */
            border: 3px solid #667eea; /* Более выразительная фиолетовая рамка */
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3); /* Тень под цвет рамки */
            transform: translateY(-1px);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Более темный фон */
            backdrop-filter: blur(5px); /* Эффект размытия */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 25px; /* Более скругленные углы */
            text-align: center;
            max-width: 400px; /* Чуть шире */
            width: 90%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); /* Более выразительная тень */
            position: relative;
            animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8rem; /* Чуть больше */
            cursor: pointer;
            color: #718096;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .ad-container {
            margin-top: 24px;
            padding: 18px;
            background-color: #e6fffa; /* Светло-зеленый фон для рекламы */
            border-radius: 16px; /* Более скругленные */
            text-align: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .ad-container img, .ad-container video {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .ad-container a {
            display: block;
            margin-top: 15px;
            font-weight: 700;
            color: #3182ce;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .ad-container a:hover {
            text-decoration: underline;
            color: #2c5282;
        }
        .text-purple-700 { color: #6b46c1; } /* Добавим явный цвет для заголовков */
        .text-purple-600 { color: #805ad5; } /* Добавим явный цвет для ссылок/акцентов */

        /* Styles for the persistent message box */
        .message-box {
            position: fixed; /* Make it fixed */
            top: 20px; /* Position at top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001; /* Above modals */
            width: 90%;
            max-width: 380px; /* Max width for readability */
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Allow clicks through when hidden */
        }
        .message-box:not(.hidden) {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .message-box.bg-red-100 { background-color: #ffebeb; }
        .message-box.text-red-700 { color: #e53e3e; }
        .message-box.bg-green-100 { background-color: #ebfef1; }
        .message-box.text-green-700 { color: #38a169; }
    </style>
</head>
<body>
    <div id="app" class="container">
        </div>
    <p id="messageBox" class="message-box hidden"></p> 

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // URL вашего бэкенда. ОБЯЗАТЕЛЬНО ЗАМЕНИТЕ НА ВАШ РЕАЛЬНЫЙ ДОМЕН С HTTPS!
        const BACKEND_URL = 'https://mygameapi.ru'; 

        // Глобальные переменные
        let currentPage = 'ageGate';
        let gameMode = 'userChoice'; // 'userChoice' или 'random'
        let selectedCategories = [];
        let allTasks = []; // Все задания, загруженные с бэкенда
        let availableTasksForSession = []; // Задания, доступные для текущей сессии после фильтрации по категориям и безопасным словам
        let playedTasksIdsInSession = []; // ID заданий, которые уже были сыграны в текущей сессии
        let currentTask = null;
        let premiumStatus = false; // Статус премиум-подписки
        let premiumPrice = 100; // Стоимость премиума, будет загружена с бэкенда
        let safeWords = []; // Слова, которые нельзя использовать в заданиях

        // --- Основная функция рендеринга страниц (определена в начале) ---
        function renderPage(pageName) {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Очищаем текущий контент
            console.log(`renderPage: Clearing appDiv.innerHTML for page: ${pageName}`); // Added log

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide(); // Скрываем кнопку по умолчанию
            }

            switch (pageName) {
                case 'ageGate':
                    renderAgeGate();
                    break;
                case 'welcome':
                    renderWelcomeScreen();
                    break;
                case 'gameModeSelection':
                    renderGameModeSelection();
                    break;
                case 'categorySelection':
                    renderCategorySelection();
                    break;
                case 'game':
                    renderGameScreen();
                    break;
                case 'settings':
                    renderSettings();
                    break;
                default:
                    renderAgeGate(); // По умолчанию
            }
            currentPage = pageName;
            console.log(`renderPage: Finished rendering for page: ${pageName}`); // Added log
        }

        // --- Инициализация Telegram Web App (перемещена после renderPage) ---
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand(); // Разворачиваем приложение на весь экран
            window.Telegram.WebApp.MainButton.setText('Начать игру');
            window.Telegram.WebApp.MainButton.onClick(handleMainButtonClick);
            window.Telegram.WebApp.onEvent('themeChanged', () => {
                // Обработка изменения темы Telegram (светлая/темная)
                // Можно обновить стили, если они зависят от темы
                console.log('Тема Telegram изменена:', window.Telegram.WebApp.themeParams);
            });
            window.Telegram.WebApp.onEvent('viewportChanged', () => {
                // Обработка изменения размеров вьюпорта
                console.log('Размер вьюпорта изменен:', window.Telegram.WebApp.viewportHeight, window.Telegram.WebApp.viewportStableHeight);
            });
            window.Telegram.WebApp.MainButton.show(); // Показываем главную кнопку Telegram
        } else {
            console.warn('Telegram Web App SDK не инициализирован. Возможно, приложение запущено вне Telegram.');
            // Для тестирования вне Telegram можно эмулировать некоторые функции
            window.Telegram = {
                WebApp: {
                    ready: () => console.log('WebApp Ready (Simulated)'),
                    expand: () => console.log('WebApp Expanded (Simulated)'),
                    MainButton: {
                        setText: (text) => console.log('MainButton Text (Simulated):', text),
                        onClick: (callback) => {
                            document.getElementById('simulated-main-button')?.removeEventListener('click', window.simulatedMainButtonHandler);
                            window.simulatedMainButtonHandler = callback;
                            const btn = document.createElement('button');
                            btn.id = 'simulated-main-button';
                            btn.className = 'btn btn-primary w-full mt-4';
                            btn.textContent = text;
                            btn.onclick = callback;
                            document.getElementById('app').appendChild(btn);
                        },
                        show: () => console.log('MainButton Show (Simulated)'),
                        hide: () => {
                            console.log('MainButton Hide (Simulated)');
                            document.getElementById('simulated-main-button')?.remove();
                        },
                        showProgress: () => console.log('MainButton Show Progress (Simulated)'),
                        hideProgress: () => console.log('MainButton Hide Progress (Simulated)'),
                        // Добавляем отсутствующие свойства, чтобы избежать ошибок
                        setParams: (params) => console.log('MainButton Set Params (Simulated):', params),
                        isActive: true,
                        isVisible: true,
                        isProgressVisible: false,
                        text: '',
                        color: '',
                        text_color: '',
                        is_active: true,
                        is_visible: true,
                    },
                    initDataUnsafe: {
                        user: { id: 'test_user_123', first_name: 'Тест', last_name: 'Пользователь' }
                    },
                    showPopup: (params, callback) => {
                        alert(params.message); // Для симуляции вне Telegram
                        if (callback) callback();
                    },
                    openTelegramLink: (url) => window.open(url, '_blank'),
                    openInvoice: (url, callback) => { // Симуляция openInvoice
                        console.log('Simulated openInvoice:', url);
                        alert('Симуляция оплаты: Открывается окно оплаты. Для реальной оплаты запустите в Telegram.');
                        if (callback) callback('paid'); // Симулируем успешную оплату
                    },
                    onEvent: (eventType, callback) => { // Симуляция onEvent
                        console.log('Simulated onEvent registered:', eventType);
                        if (eventType === 'invoiceClosed') {
                            // Можно добавить логику для симуляции закрытия инвойса
                        }
                    },
                    ready: () => console.log('Telegram WebApp Ready (Simulated)'),
                    expand: () => console.log('Telegram WebApp Expanded (Simulated)'),
                    isExpanded: true,
                    viewportHeight: window.innerHeight,
                    viewportStableHeight: window.innerHeight,
                    themeParams: {
                        bg_color: '#ffffff',
                        text_color: '#000000',
                    },
                    BackButton: {
                        isVisible: false,
                        show: () => console.log('Simulated BackButton Show'),
                        hide: () => console.log('Simulated BackButton Hide'),
                        onClick: (cb) => console.log('Simulated BackButton onClick'),
                    },
                    setHeaderColor: (color) => console.log('Simulated setHeaderColor:', color),
                    setBackgroundColor: (color) => console.log('Simulated setBackgroundColor:', color),
                }
            };
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.MainButton.setText('Начать игру (Симуляция)');
            window.Telegram.WebApp.MainButton.onClick(handleMainButtonClick);
            window.Telegram.WebApp.MainButton.show();
        }

        // --- Вспомогательные функции (перемещены после renderPage) ---
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = `message-box ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                messageBox.classList.remove('hidden');
                // Auto-hide after a few seconds
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000); // Hide after 5 seconds
            } else {
                console.log(`Message (${isError ? 'Error' : 'Info'}): ${message}`);
            }
        }

        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.classList.add('hidden');
            }
        }

        // Новая функция apiCall для централизованных запросов к бэкенду
        async function apiCall(method, path, data = null) {
            const headers = { 'Content-Type': 'application/json' };
            const options = { method, headers };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(`${BACKEND_URL}${path}`, options);
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `Ошибка API: ${response.status}`);
                }
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                showMessage(`Ошибка связи с сервером: ${error.message}. Пожалуйста, попробуйте позже.`, true);
                throw error;
            }
        }

        function showModal(title, message, buttons = []) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal';
            modalOverlay.id = 'app-modal';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            const closeBtn = document.createElement('span');
            closeBtn.className = 'modal-close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => modalOverlay.remove();
            modalContent.appendChild(closeBtn);

            const modalTitle = document.createElement('h3');
            modalTitle.className = 'text-2xl font-bold mb-4 text-purple-700'; /* Улучшенный заголовок */
            modalTitle.textContent = title;
            modalContent.appendChild(modalTitle);

            const modalMessage = document.createElement('p');
            modalMessage.className = 'text-gray-700 mb-6 text-lg'; /* Крупнее текст */
            modalMessage.innerHTML = message;
            modalContent.appendChild(modalMessage);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-col gap-3';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.className = `btn ${btnInfo.className || 'btn-secondary'} w-full`;
                button.textContent = btnInfo.text;
                button.onclick = () => {
                    modalOverlay.remove();
                    if (btnInfo.handler) btnInfo.handler();
                };
                buttonContainer.appendChild(button);
            });
            modalContent.appendChild(buttonContainer);

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
        }

        // --- Функции рендеринга страниц ---

        function renderAgeGate() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-purple-700">Добро пожаловать в "Правда или Действие" для пар!</h2>
                <p class="text-gray-600 mb-6">Это приложение содержит контент 18+. Пожалуйста, подтвердите, что вам исполнилось 18 лет.</p>
                <div class="flex items-center mb-6">
                    <input type="checkbox" id="ageConfirm" class="form-checkbox h-5 w-5 text-purple-600 rounded-md">
                    <label for="ageConfirm" class="ml-2 text-gray-700 text-sm">Я подтверждаю, что мне 18 лет или более, и я согласен(на) с <a href="#" id="termsLink" class="text-purple-600 hover:underline">Условиями использования</a> и <a href="#" id="privacyLink" class="text-purple-600 hover:underline">Политикой конфиденциальности</a>.</label>
                </div>
                <button id="confirmAgeBtn" class="btn btn-primary w-full opacity-50 cursor-not-allowed" disabled>Продолжить</button>
            `;
            console.log('renderAgeGate: appDiv.innerHTML set.'); // Added log

            const ageConfirmCheckbox = document.getElementById('ageConfirm');
            const confirmAgeBtn = document.getElementById('confirmAgeBtn');
            const termsLink = document.getElementById('termsLink');
            const privacyLink = document.getElementById('privacyLink');

            ageConfirmCheckbox.addEventListener('change', () => {
                confirmAgeBtn.disabled = !ageConfirmCheckbox.checked;
                confirmAgeBtn.classList.toggle('opacity-50', !ageConfirmCheckbox.checked);
                confirmAgeBtn.classList.toggle('cursor-not-allowed', !confirmAgeBtn.disabled);
            });

            confirmAgeBtn.addEventListener('click', () => {
                if (ageConfirmCheckbox.checked) {
                    localStorage.setItem('ageConfirmed', 'true');
                    renderPage('welcome');
                } else {
                    showModal('Ошибка', 'Пожалуйста, подтвердите свой возраст и согласие с условиями.');
                }
            });

            termsLink.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('Условия использования', `
                    <p class="mb-3">Приложение "Правда или Действие для пар" предназначено исключительно для совершеннолетних пользователей (18+).</p>
                    <p class="mb-3">Все задания должны выполняться только по обоюдному согласию обоих партнеров. Разработчик не несет ответственности за действия пользователей.</p>
                    <p class="mb-3">Запрещено использование приложения для распространения незаконного контента (например, детской порнографии, насилия).</p>
                    <p>Мы оставляем за собой право блокировать аккаунты, нарушающие данные условия.</p>
                `);
            });

            privacyLink.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('Политика конфиденциальности', `
                    <p class="mb-3">Мы ценим вашу конфиденциальность. Приложение не собирает личные данные, такие как имена, адреса или контактную информацию.</p>
                    <p class="mb-3">Мы можем собирать анонимные данные об использовании приложения (например, количество сыгранных раундов, популярность категорий) для улучшения функционала.</p>
                    <p class="mb-3">Все интимные данные, которые вы вводите (например, безопасные слова), хранятся только локально на вашем устройстве и не передаются на наши серверы.</p>
                    <p>Платежи через Telegram Stars обрабатываются Telegram и TON, мы не получаем и не храним вашу платежную информацию.</p>
                `);
            });
        }

        function renderWelcomeScreen() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-purple-700">Привет! ✨</h2>
                <p class="text-gray-600 mb-6 text-lg">Добро пожаловать в "Правда или Действие" – идеальную игру для сближения с партнёром.</p>
                <button id="startGameBtn" class="btn btn-primary w-full">Начать новую игру</button>
                <button id="settingsBtn" class="btn btn-secondary w-full">Настройки</button>
            `;
            console.log('renderWelcomeScreen: appDiv.innerHTML set.'); // Added log
            document.getElementById('startGameBtn').addEventListener('click', () => renderPage('gameModeSelection'));
            document.getElementById('settingsBtn').addEventListener('click', () => renderPage('settings'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide(); // На этом экране главная кнопка не нужна
            }
        }

        function renderGameModeSelection() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-purple-700">Выберите режим игры</h2>
                <p class="text-gray-600 mb-6">Как вы хотите играть?</p>
                <button id="userChoiceModeBtn" class="btn ${gameMode === 'userChoice' ? 'btn-primary' : 'btn-secondary'} w-full mb-3">
                    Наш Выбор (Вы сами выбираете "Правду" или "Действие")
                </button>
                <button id="randomModeBtn" class="btn ${gameMode === 'random' ? 'btn-primary' : 'btn-secondary'} w-full mb-6">
                    Сюрприз (Приложение выбирает случайным образом)
                </button>
                <button id="confirmModeBtn" class="btn btn-green w-full">Продолжить</button>
                <button id="backFromGameModeBtn" class="btn btn-secondary w-full mt-4">Назад</button>
            `;
            console.log('renderGameModeSelection: appDiv.innerHTML set.'); // Added log

            document.getElementById('userChoiceModeBtn').addEventListener('click', () => {
                gameMode = 'userChoice';
                renderGameModeSelection(); // Перерисовываем для обновления стилей
            });
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                gameMode = 'random';
                renderGameModeSelection(); // Перерисовываем для обновления стилей
            });
            document.getElementById('confirmModeBtn').addEventListener('click', () => renderPage('categorySelection'));
            document.getElementById('backFromGameModeBtn').addEventListener('click', () => renderPage('welcome'));
        }

        async function renderCategorySelection() {
            // Перед рендерингом категорий, обновим премиум-статус
            await checkPremiumStatus(); 

            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-purple-700">Выберите категории заданий</h2>
                <p class="text-gray-600 mb-6">Выберите те, что вам по душе. Платные категории доступны после покупки.</p>
                <div id="categoriesList" class="flex flex-col gap-3 mb-6">
                    </div>
                <button id="startGameFromCategoriesBtn" class="btn btn-green w-full">Начать игру</button>
                <button id="buyPremiumBtn" class="btn btn-primary w-full mt-3">Купить Премиум / ${premiumPrice} Stars</button>
                <button id="backFromCategoryBtn" class="btn btn-secondary w-full mt-4">Назад</button>
            `;
            console.log('renderCategorySelection: appDiv.innerHTML set.'); // Added log

            const categoriesList = document.getElementById('categoriesList');
            try {
                const fetchedCategories = await apiCall('GET', '/api/categories'); // Используем apiCall
                allCategories = fetchedCategories.categories; // Обновляем allCategories
                
                allCategories.forEach(cat => {
                    const isSelected = selectedCategories.includes(cat.name);
                    const isPaid = cat.level === 'paid';
                    const isDisabled = isPaid && !premiumStatus;

                    const categoryItem = document.createElement('div');
                    categoryItem.className = `category-item ${isSelected ? 'selected' : ''} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                    categoryItem.innerHTML = `
                        <div class="text-left">
                            <p class="font-semibold text-gray-800">${cat.name} ${isPaid ? '<span class="text-yellow-600 text-sm font-bold">🌟 Премиум</span>' : ''}</p>
                            <p class="text-sm text-gray-500">${cat.description}</p>
                        </div>
                        ${isDisabled ? '<span class="text-red-500 text-xl">🔒</span>' : '<input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 rounded-md" ' + (isSelected ? 'checked' : '') + '>'}
                    `;
                    if (!isDisabled) {
                        categoryItem.addEventListener('click', () => {
                            if (selectedCategories.includes(cat.name)) {
                                selectedCategories = selectedCategories.filter(name => name !== cat.name);
                            } else {
                                selectedCategories.push(cat.name);
                            }
                            renderCategorySelection(); // Перерисовываем для обновления стилей
                        });
                    }
                    categoriesList.appendChild(categoryItem);
                });
                // Убираем сообщение об ошибке, если категории успешно загрузились
                document.getElementById('categoryLoadError')?.remove(); 

            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
                // Добавляем сообщение об ошибке только если его еще нет
                if (!document.getElementById('categoryLoadError')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'categoryLoadError';
                    errorDiv.className = 'text-red-500 text-center mb-4';
                    errorDiv.textContent = 'Не удалось загрузить категории. Пожалуйста, убедитесь, что бэкенд запущен и доступен.';
                    categoriesList.before(errorDiv); // Вставляем перед списком категорий
                }
            }


            document.getElementById('startGameFromCategoriesBtn').addEventListener('click', startGame);
            document.getElementById('buyPremiumBtn').addEventListener('click', showPremiumPurchase);
            document.getElementById('backFromCategoryBtn').addEventListener('click', () => renderPage('gameModeSelection'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide();
            }
        }

        function renderGameScreen() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-purple-700">Ваше задание:</h2>
                <div id="taskCard" class="card mb-6">Нажмите "Следующее задание"</div>
                <div id="gameControls" class="flex flex-col gap-3">
                    ${gameMode === 'userChoice' ? `
                        <div class="flex gap-3">
                            <button id="chooseTruthBtn" class="btn btn-primary w-1/2">Правда</button>
                            <button id="chooseDareBtn" class="btn btn-primary w-1/2">Действие</button>
                        </div>
                    ` : ''}
                    <button id="nextTaskBtn" class="btn btn-green w-full">Следующее задание</button>
                    <button id="skipTaskBtn" class="btn btn-secondary w-full">Пропустить</button>
                    <button id="backToCategoriesBtn" class="btn btn-secondary w-full mt-4">Сменить категории</button>
                </div>
                <div id="adDisplay" class="ad-container hidden"></div>
            `;
            console.log('renderGameScreen: appDiv.innerHTML set.'); // Added log

            if (gameMode === 'userChoice') {
                document.getElementById('chooseTruthBtn').addEventListener('click', () => getNextTask('truth'));
                document.getElementById('chooseDareBtn').addEventListener('click', () => getNextTask('dare'));
            }
            document.getElementById('nextTaskBtn').addEventListener('click', () => getNextTask(gameMode === 'random' ? null : currentTask?.type));
            document.getElementById('skipTaskBtn').addEventListener('click', skipTask);
            document.getElementById('backToCategoriesBtn').addEventListener('click', () => renderPage('categorySelection'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide();
            }
            displayAd(); // Показываем рекламу при загрузке игрового экрана
        }

        function renderSettings() {
            const appDiv = document.getElementById('app');
            // Загружаем безопасные слова из localStorage
            const storedSafeWords = localStorage.getItem('safeWords');
            safeWords = storedSafeWords ? JSON.parse(storedSafeWords) : [];

            appDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-purple-700">Настройки</h2>
                <div class="mb-6 text-left">
                    <h3 class="text-xl font-semibold mb-3">Безопасные слова / Границы комфорта</h3>
                    <p class="text-gray-600 mb-2">Введите слова или фразы, которые не должны появляться в заданиях (например, "еда", "публично", "БДСМ"). Разделяйте запятыми.</p>
                    <input type="text" id="safeWordsInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Например: еда, публично">
                    <button id="saveSafeWordsBtn" class="btn btn-primary w-full mt-3">Сохранить безопасные слова</button>
                    <p class="text-sm text-gray-500 mt-2">Текущие безопасные слова: <span id="currentSafeWords">${safeWords.join(', ') || 'Нет'}</span></p>
                </div>
                <button id="backToWelcomeBtn" class="btn btn-secondary w-full mt-4">Назад</button>
            `;
            console.log('renderSettings: appDiv.innerHTML set.'); // Added log

            const safeWordsInput = document.getElementById('safeWordsInput');
            safeWordsInput.value = safeWords.join(', ');

            document.getElementById('saveSafeWordsBtn').addEventListener('click', () => {
                const newSafeWords = safeWordsInput.value.split(',').map(s => s.trim().toLowerCase()).filter(s => s.length > 0);
                safeWords = newSafeWords;
                localStorage.setItem('safeWords', JSON.stringify(safeWords));
                document.getElementById('currentSafeWords').textContent = safeWords.join(', ') || 'Нет';
                showModal('Сохранено', 'Безопасные слова успешно обновлены.');
            });

            document.getElementById('backToWelcomeBtn').addEventListener('click', () => renderPage('welcome'));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.hide();
            }
        }

        // --- Логика игры ---

        async function fetchTasksAndCategories() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                window.Telegram.WebApp.MainButton.showProgress();
            }
            try {
                const tasksResponse = await apiCall('GET', '/api/tasks'); // Используем apiCall
                allTasks = tasksResponse.tasks; // Сохраняем все задания

                const categoriesResponse = await apiCall('GET', '/api/categories'); // Используем apiCall
                allCategories = categoriesResponse.categories; // Обновляем allCategories
                
                return true;

            } catch (error) {
                console.error('Ошибка загрузки заданий или категорий:', error);
                // Это сообщение будет показано только если бэкенд действительно недоступен
                showModal('Ошибка', 'Не удалось загрузить данные. Пожалуйста, убедитесь, что бэкенд запущен.');
                return false;
            } finally {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
                    window.Telegram.WebApp.MainButton.hideProgress();
                }
            }
        }

        // Новая функция для проверки премиум-статуса пользователя
        async function checkPremiumStatus() {
            const userId = window.Telegram.WebApp.initDataUnsafe.user?.id;
            if (!userId) {
                console.warn('User ID not available for premium status check. Using fake ID for testing.');
                premiumStatus = false;
                localStorage.setItem('premiumStatus', 'false');
                return;
            }

            try {
                const data = await apiCall('GET', `/api/users/${userId}/premium`); // Используем apiCall
                premiumStatus = data.premium; // Теперь premium будет true только если подписка активна
                localStorage.setItem('premiumStatus', premiumStatus.toString()); // Сохраняем актуальный статус
                console.log(`Premium status for user ${userId}: ${premiumStatus}`);
            } catch (error) {
                console.error('Error checking premium status:', error);
                premiumStatus = false;
                localStorage.setItem('premiumStatus', 'false');
            }
        }

        async function fetchPremiumPrice() {
            try {
                const result = await apiCall('GET', '/api/admin/settings/premium-price'); // Используем apiCall
                premiumPrice = result.premiumPrice;
                console.log('Стоимость премиум-подписки загружена:', premiumPrice);
            } catch (error) {
                console.error('Ошибка загрузки стоимости премиум-подписки:', error);
                premiumPrice = 100; // Дефолтное значение, если не удалось загрузить
            }
        }

        async function startGame() {
            if (selectedCategories.length === 0) {
                showModal('Внимание', 'Пожалуйста, выберите хотя бы одну категорию заданий.');
                return;
            }

            // Фильтруем задания для текущей сессии
            availableTasksForSession = allTasks.filter(task => {
                const isCategorySelected = selectedCategories.includes(task.category);
                const isPremiumContent = task.level === 'paid';
                const isAllowedByPremium = !isPremiumContent || premiumStatus;
                return isCategorySelected && isAllowedByPremium;
            });

            // Фильтрация по безопасным словам
            availableTasksForSession = availableTasksForSession.filter(task => {
                const taskText = task.text.toLowerCase();
                return !safeWords.some(word => taskText.includes(word));
            });

            if (availableTasksForSession.length === 0) {
                showModal('Внимание', 'Нет доступных заданий для выбранных категорий и безопасных слов. Попробуйте выбрать другие категории или изменить настройки безопасных слов.');
                renderPage('categorySelection'); // Возвращаем на выбор категорий
                return;
            }

            playedTasksIdsInSession = []; // Сбрасываем сыгранные задания для новой сессии
            renderPage('game');
        }

        function getNextTask(type = null) {
            const taskCard = document.getElementById('taskCard');
            taskCard.textContent = 'Загрузка...';

            let filteredTasks = availableTasksForSession.filter(task => !playedTasksIdsInSession.includes(task.id));

            if (type) {
                filteredTasks = filteredTasks.filter(task => task.type === type);
            }

            if (filteredTasks.length === 0) {
                showModal('Конец раунда', 'Вы выполнили все доступные задания в выбранных категориях! Начните новую игру или смените категории.');
                playedTasksIdsInSession = []; // Сброс для возможности начать заново
                taskCard.textContent = 'Нажмите "Следующее задание"';
                currentTask = null;
                return;
            }

            const randomIndex = Math.floor(Math.random() * filteredTasks.length);
            currentTask = filteredTasks[randomIndex];

            taskCard.innerHTML = `<span class="font-bold text-purple-700">${currentTask.type === 'truth' ? 'Правда:' : 'Действие:'}</span> ${currentTask.text}`;
            playedTasksIdsInSession.push(currentTask.id);

            // Отправка аналитики о выполненном задании (симуляция)
            sendAnalytics({
                event: 'task_completed',
                taskId: currentTask.id,
                category: currentTask.category,
                type: currentTask.type,
                userId: window.Telegram.WebApp.initDataUnsafe.user?.id || 'anonymous'
            });
            displayAd(); // Показываем рекламу после каждого задания
        }

        function skipTask() {
            if (!currentTask) {
                showModal('Внимание', 'Сначала получите задание, чтобы его пропустить.');
                return;
            }
            showModal('Задание пропущено', 'Это задание было пропущено. Получите следующее!', [
                { text: 'ОК', className: 'btn-primary', handler: () => getNextTask(gameMode === 'random' ? null : currentTask?.type) }
            ]);
        }

        function showPremiumPurchase() {
            showModal('Премиум-доступ', `
                <p class="mb-3">Разблокируйте все категории заданий и дополнительные функции, купив премиум-доступ!</p>
                <p class="font-bold mt-4 text-xl">Стоимость: ${premiumPrice} Stars (на 1 месяц)</p>
            `, [
                { text: `Купить за ${premiumPrice} Stars`, className: 'btn-primary', handler: initiateTelegramStarsPurchase }
            ]);
        }

        // Новая функция для инициирования покупки через Telegram Stars
        async function initiateTelegramStarsPurchase() {
            if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe.user?.id) {
                showModal('Ошибка', 'Приложение запущено вне Telegram или ID пользователя недоступен. Для покупки запустите приложение в Telegram.');
                return;
            }

            const userId = window.Telegram.WebApp.initDataUnsafe.user.id;
            const amount = premiumPrice; // Стоимость премиума в Stars
            const item = 'premium_access';

            try {
                // Запрос на бэкенд для создания invoice link
                const result = await apiCall('POST', '/api/purchase/initiate', { userId, amount, item }); // Используем apiCall
                
                if (result.invoice_url) {
                    // Открываем платежный интерфейс Telegram
                    window.Telegram.WebApp.openInvoice(result.invoice_url, async (status) => {
                        if (status === 'paid') {
                            showModal('Поздравляем! 🎉', 'Премиум-доступ активирован! Спасибо за покупку.');
                            // После успешной оплаты, обновим статус премиума с бэкенда
                            await checkPremiumStatus(); 
                            renderPage('categorySelection'); // Перерисовываем для обновления категорий
                            sendAnalytics({
                                event: 'premium_purchased_stars',
                                userId: userId,
                                amount: amount
                            });
                        } else if (status === 'cancelled') {
                            // Улучшенное сообщение для отмены
                            showModal('Покупка отменена', 'Вы отменили покупку премиум-доступа. Вы всегда можете вернуться и приобрести его позже!');
                        } else if (status === 'failed') {
                            // Улучшенное сообщение для ошибки
                            showModal('Ошибка покупки', 'Произошла ошибка при обработке платежа. Пожалуйста, попробуйте еще раз или свяжитесь с поддержкой.');
                        } else {
                            showModal('Статус покупки', `Статус: ${status}.`);
                        }
                    });
                } else {
                    showModal('Ошибка', result.message || 'Не удалось инициировать покупку Stars. Пожалуйста, попробуйте позже.');
                }
            } catch (error) {
                console.error('Ошибка при инициировании покупки Stars:', error);
                showModal('Ошибка', 'Произошла ошибка при инициировании покупки. Проверьте подключение к бэкенду или попробуйте позже.');
            }
        }

        async function sendAnalytics(data) {
            try {
                await apiCall('POST', '/api/analytics', data); // Используем apiCall
                console.log('Аналитика отправлена:', data);
            } catch (error) {
                console.error('Ошибка отправки аналитики:', error);
            }
        }

        let adCounter = 0;
        const AD_INTERVAL = 3; // Показывать рекламу каждые 3 задания

        async function displayAd() {
            const adDisplayDiv = document.getElementById('adDisplay');
            adCounter++;

            if (premiumStatus) { // Не показываем рекламу для премиум-пользователей
                adDisplayDiv.classList.add('hidden');
                return;
            }

            if (adCounter % AD_INTERVAL === 0) {
                try {
                    const adData = await apiCall('GET', '/api/ads/current'); // Используем apiCall
                    let mediaHtml = '';
                    if (adData.type === 'image') {
                        mediaHtml = `<img src="${adData.url}" alt="Реклама" class="w-full h-auto object-cover">`;
                    } else if (adData.type === 'video') {
                        mediaHtml = `<video src="${adData.url}" controls class="w-full h-auto object-cover"></video>`;
                    }

                    adDisplayDiv.innerHTML = `
                        <p class="text-sm text-gray-500 mb-2">Реклама</p>
                        ${mediaHtml}
                        <a href="${adData.link}" target="_blank" class="btn btn-secondary mt-3">
                            ${adData.text || 'Подробнее'}
                        </a>
                    `;
                    adDisplayDiv.classList.remove('hidden');
                } catch (error) {
                    console.error('Ошибка загрузки рекламы:', error);
                    adDisplayDiv.classList.add('hidden');
                }
            } else {
                adDisplayDiv.classList.add('hidden');
            }
        }


        // --- Главная кнопка Telegram ---
        function handleMainButtonClick() {
            // Эта функция вызывается при нажатии на Главную кнопку Telegram
            // Её поведение зависит от текущей страницы
            if (currentPage === 'welcome') {
                renderPage('gameModeSelection');
            } else if (currentPage === 'gameModeSelection') {
                renderPage('categorySelection');
            } else if (currentPage === 'categorySelection') {
                startGame();
            } else if (currentPage === 'game') {
                getNextTask(gameMode === 'random' ? null : currentTask?.type);
            }
        }

        // --- Инициализация приложения ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired. Attempting to render initial page.');
            // Загружаем стоимость премиум-подписки
            await fetchPremiumPrice();

            // Загружаем все задания и категории с бэкенда при старте
            const dataLoaded = await fetchTasksAndCategories();
            if (!dataLoaded) {
                // Если данные не загрузились, возможно, бэкенд не запущен.
                // Можно показать сообщение об ошибке или предложить повторить попытку.
                // Пока оставим на текущей странице (ageGate/welcome), чтобы пользователь мог увидеть ошибку.
            }

            // Проверяем статус подтверждения возраста
            const ageConfirmed = localStorage.getItem('ageConfirmed') === 'true';
            if (ageConfirmed) {
                // Если возраст подтвержден, сразу проверяем премиум-статус с бэкенда
                await checkPremiumStatus(); 
                console.log('Age confirmed, rendering welcome page.');
                renderPage('welcome');
            } else {
                console.log('Age not confirmed, rendering age gate page.');
                renderPage('ageGate');
            }
        });
    </script>
</body>
</html>
