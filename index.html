<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игра для пар: Правда или Действие</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to right top, #f0f2f5, #e0e6eb); /* Мягкий градиент */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden; /* Предотвращаем горизонтальный скролл */
        }
        .container {
            width: 100%;
            max-width: 420px; /* Оптимизация для мобильных устройств */
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); /* Более выразительная тень */
            padding: 24px;
            box-sizing: border-box;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px; /* Более округлые кнопки */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 1.1rem;
        }
        .btn-primary {
            background-image: linear-gradient(to right top, #a78bfa, #8b5cf6); /* Фиолетовый градиент */
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right top, #9773f0, #7c4ee0);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Мягкий серый */
            color: #4a5568;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #cbd5e0;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-outline {
            background-color: transparent;
            color: #8b5cf6;
            border: 2px solid #8b5cf6;
        }
        .btn-outline:hover {
            background-color: #8b5cf6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .card {
            background-color: #f8fafc;
            border-radius: 15px;
            padding: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .card.selected {
            border: 3px solid #8b5cf6;
            background-color: #eef2ff; /* Светло-фиолетовый фон для выбранной */
        }
        .card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f0f4f8;
        }
        .message-box {
            background-color: #ffebeb;
            color: #e53e3e;
            padding: 12px;
            border-radius: 10px;
            margin-top: 16px;
            font-weight: 600;
            text-align: center;
        }
        .ad-banner {
            background-color: #f0f4f8;
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .ad-banner img, .ad-banner video {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .ad-banner a {
            color: #8b5cf6;
            font-weight: 600;
            text-decoration: none;
        }
        .ad-banner a:hover {
            text-decoration: underline;
        }
        .premium-info {
            background-color: #eef2ff;
            color: #6d28d9;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
        }
        .task-display {
            min-height: 150px; /* Увеличиваем высоту для лучшего отображения */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        </div>

    <script>
        // URL вашего бэкенда. ОБЯЗАТЕЛЬНО ЗАМЕНИТЕ НА ВАШ РЕАЛЬНЫЙ ДОМЕН С HTTPS!
        const BACKEND_URL = 'https://mygameapi.ru'; // <-- Убедитесь, что это ваш реальный домен!

        let currentPage = '';
        let gameMode = 'random'; // 'random' или 'category'
        let selectedCategories = [];
        let allCategories = [];
        let allTasks = [];
        let currentTask = null;
        let isPremiumUser = false; // Статус премиум-пользователя
        let telegramUserId = null; // ID пользователя Telegram Mini App
        let premiumPrice = 100; // Дефолтная цена, будет обновлена с бэкенда

        // --- Вспомогательные функции ---
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = `message-box ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                messageBox.classList.remove('hidden');
            } else {
                console.log(`Message (${isError ? 'Error' : 'Info'}): ${message}`);
            }
        }

        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.classList.add('hidden');
            }
        }

        async function apiCall(method, path, data = null) {
            const headers = { 'Content-Type': 'application/json' };
            const options = { method, headers };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(`${BACKEND_URL}${path}`, options);
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Ошибка API');
                }
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                showMessage(`Ошибка: ${error.message}`, true);
                throw error;
            }
        }

        // --- Получение данных с бэкенда ---
        async function fetchTasksAndCategories() {
            try {
                const [tasksResponse, categoriesResponse] = await Promise.all([
                    apiCall('GET', '/api/tasks'),
                    apiCall('GET', '/api/categories')
                ]);
                allTasks = tasksResponse.tasks;
                allCategories = categoriesResponse.categories;
                console.log('Задания и категории загружены:', { allTasks, allCategories });
                return true;
            } catch (error) {
                console.error('Ошибка загрузки заданий или категорий:', error);
                showMessage('Не удалось загрузить категории и задания. Пожалуйста, убедитесь, что бэкенд запущен и доступен.', true);
                return false;
            }
        }

        async function checkPremiumStatus() {
            if (telegramUserId) {
                try {
                    const result = await apiCall('GET', `/api/users/${telegramUserId}/premium`);
                    isPremiumUser = result.premium;
                    console.log('Премиум статус пользователя:', isPremiumUser);
                } catch (error) {
                    console.error('Ошибка проверки премиум статуса:', error);
                    isPremiumUser = false; // На всякий случай сбрасываем, если ошибка
                }
            }
        }

        async function fetchPremiumPrice() {
            try {
                const result = await apiCall('GET', '/api/admin/settings/premium-price');
                premiumPrice = result.premiumPrice;
                console.log('Стоимость премиум-подписки загружена:', premiumPrice);
            } catch (error) {
                console.error('Ошибка загрузки стоимости премиум-подписки:', error);
                // Если не удалось загрузить, используем дефолтное значение 100 Stars
                premiumPrice = 100; 
            }
        }


        // --- Рендеринг страниц ---
        function renderPage(pageName) {
            currentPage = pageName;
            const appContainer = document.getElementById('appContainer');
            appContainer.innerHTML = ''; // Очищаем содержимое

            let html = '';
            switch (pageName) {
                case 'ageGate':
                    html = `
                        <h1 class="text-3xl font-bold text-purple-700">Подтверждение возраста</h1>
                        <p class="text-gray-600">Вам есть 18 лет?</p>
                        <button id="confirmAgeBtn" class="btn btn-primary">Да, мне есть 18</button>
                        <p id="ageGateMessage" class="message-box hidden"></p>
                    `;
                    break;
                case 'welcome':
                    html = `
                        <h1 class="text-3xl font-bold text-purple-700">Добро пожаловать в "Правда или Действие"!</h1>
                        <p class="text-gray-600">Выберите режим игры:</p>
                        <button id="randomModeBtn" class="btn btn-primary">Случайные задания</button>
                        <button id="categoryModeBtn" class="btn btn-outline">Выбрать категории</button>
                        <button id="premiumPurchaseBtn" class="btn btn-secondary">Купить Премиум / ${premiumPrice} Stars</button>
                        <p id="welcomeMessage" class="message-box hidden"></p>
                    `;
                    break;
                case 'gameModeSelection': // Эта страница больше не используется напрямую, переходы идут сразу
                    // from welcome to categorySelection or startGame
                    break;
                case 'categorySelection':
                    html = `
                        <h1 class="text-3xl font-bold text-purple-700">Выберите категории заданий</h1>
                        <p class="text-gray-600">Выберите те, что вам по душе.</p>
                        ${!isPremiumUser ? '<p class="premium-info">Платные категории доступны после покупки.</p>' : ''}
                        <div id="categoriesList" class="flex flex-col gap-3">
                            </div>
                        <button id="startGameBtn" class="btn btn-primary">Начать игру</button>
                        <button id="backToWelcomeBtn" class="btn btn-secondary">Назад</button>
                        <p id="categorySelectionMessage" class="message-box hidden"></p>
                    `;
                    break;
                case 'game':
                    html = `
                        <h1 class="text-3xl font-bold text-purple-700 mb-4">Играем!</h1>
                        <div id="taskDisplay" class="task-display">Нажмите "Далее", чтобы получить задание...</div>
                        <button id="nextTaskBtn" class="btn btn-primary">Далее</button>
                        <button id="showAdBtn" class="btn btn-outline hidden">Показать рекламу</button>
                        <div id="adDisplay" class="ad-banner hidden"></div>
                        <button id="endGameBtn" class="btn btn-secondary">Завершить игру</button>
                        <p id="gameMessage" class="message-box hidden"></p>
                    `;
                    break;
            }
            appContainer.innerHTML = html;
            attachEventListeners(pageName);
        }

        // --- Обработчики событий ---
        function attachEventListeners(pageName) {
            hideMessage(); // Скрываем сообщения при смене страницы

            if (pageName === 'ageGate') {
                document.getElementById('confirmAgeBtn').addEventListener('click', () => {
                    localStorage.setItem('ageConfirmed', 'true');
                    // После подтверждения возраста, сразу проверяем премиум-статус
                    checkPremiumStatus().then(() => {
                        renderPage('welcome');
                    });
                });
            } else if (pageName === 'welcome') {
                document.getElementById('randomModeBtn').addEventListener('click', () => {
                    gameMode = 'random';
                    startGame(); // Сразу начинаем игру со случайными заданиями
                });
                document.getElementById('categoryModeBtn').addEventListener('click', () => {
                    gameMode = 'category';
                    renderPage('categorySelection');
                });
                document.getElementById('premiumPurchaseBtn').addEventListener('click', initiatePremiumPurchase);
            } else if (pageName === 'categorySelection') {
                renderCategoriesList(); // Загружаем категории
                document.getElementById('startGameBtn').addEventListener('click', startGame);
                document.getElementById('backToWelcomeBtn').addEventListener('click', () => renderPage('welcome'));
            } else if (pageName === 'game') {
                document.getElementById('nextTaskBtn').addEventListener('click', getNextTask);
                document.getElementById('showAdBtn').addEventListener('click', showAd);
                document.getElementById('endGameBtn').addEventListener('click', () => renderPage('welcome'));
            }
        }

        // --- Логика игры ---
        function startGame() {
            if (gameMode === 'category' && selectedCategories.length === 0) {
                showMessage('Пожалуйста, выберите хотя бы одну категорию.', true);
                return;
            }
            renderPage('game');
            getNextTask();
        }

        async function getNextTask(forceType = null) {
            hideMessage();
            const taskDisplay = document.getElementById('taskDisplay');
            const showAdBtn = document.getElementById('showAdBtn');
            const adDisplay = document.getElementById('adDisplay');

            taskDisplay.textContent = 'Загрузка задания...';
            showAdBtn.classList.add('hidden');
            adDisplay.classList.add('hidden');
            adDisplay.innerHTML = '';

            let availableTasks = [];

            if (gameMode === 'random') {
                // В случайном режиме используем все доступные задания (с учетом премиума)
                availableTasks = allTasks.filter(task => isPremiumUser || task.level === 'free');
            } else {
                // В режиме категорий используем только выбранные категории (с учетом премиума)
                availableTasks = allTasks.filter(task =>
                    selectedCategories.includes(task.category) && (isPremiumUser || task.level === 'free')
                );
            }

            if (availableTasks.length === 0) {
                taskDisplay.textContent = 'Нет доступных заданий в выбранных категориях или режиме.';
                return;
            }

            // Фильтруем по типу, если нужно (для "Правда" или "Действие" кнопки)
            if (forceType) {
                availableTasks = availableTasks.filter(task => task.type === forceType);
            }

            if (availableTasks.length === 0) {
                taskDisplay.textContent = `Нет доступных заданий типа "${forceType === 'truth' ? 'Правда' : 'Действие'}" в выбранных категориях.`;
                return;
            }

            currentTask = availableTasks[Math.floor(Math.random() * availableTasks.length)];
            taskDisplay.innerHTML = `
                <div class="text-xl font-bold mb-2">${currentTask.type === 'truth' ? 'Правда' : 'Действие'}</div>
                <div class="text-2xl">${currentTask.text}</div>
            `;

            // Отправляем аналитику о выполненном задании
            if (telegramUserId) {
                apiCall('POST', '/api/analytics', {
                    event: 'task_completed',
                    userId: telegramUserId,
                    data: { taskId: currentTask.id, category: currentTask.category, type: currentTask.type }
                }).catch(e => console.error('Ошибка отправки аналитики:', e));
            }

            // Показываем рекламу, если пользователь не премиум
            if (!isPremiumUser) {
                showAdBtn.classList.remove('hidden');
            }
        }

        async function showAd() {
            hideMessage();
            const adDisplay = document.getElementById('adDisplay');
            adDisplay.innerHTML = 'Загрузка рекламы...';
            adDisplay.classList.remove('hidden');

            try {
                const ad = await apiCall('GET', '/api/ads/current');
                adDisplay.innerHTML = `
                    <p class="text-lg font-semibold mb-2">${ad.text || 'Рекламное сообщение'}</p>
                    ${ad.type === 'image' ? `<img src="${ad.url}" alt="Реклама" class="w-full h-auto">` : ''}
                    ${ad.type === 'video' ? `<video src="${ad.url}" controls class="w-full h-auto"></video>` : ''}
                    <a href="${ad.link}" target="_blank" class="block mt-2">Перейти на сайт</a>
                `;
                // Отправляем аналитику о просмотре рекламы
                if (telegramUserId) {
                    apiCall('POST', '/api/analytics', {
                        event: 'ad_viewed',
                        userId: telegramUserId,
                        data: { adId: ad.id, adType: ad.type }
                    }).catch(e => console.error('Ошибка отправки аналитики:', e));
                }
            } catch (error) {
                adDisplay.innerHTML = '<p class="text-red-500">Не удалось загрузить рекламу.</p>';
            }
        }

        async function initiatePremiumPurchase() {
            hideMessage();
            // Проверяем наличие Telegram WebApp API
            if (!window.Telegram || !window.Telegram.WebApp) {
                showMessage('Функция покупки премиум-доступа доступна только при запуске приложения внутри Telegram.', true);
                console.warn('Telegram WebApp API не доступен. Покупка невозможна.');
                return; // Прерываем выполнение функции
            }

            if (!telegramUserId) {
                showMessage('Не удалось определить ID пользователя Telegram. Пожалуйста, попробуйте перезапустить Mini App.', true);
                return;
            }
            try {
                // Отправляем аналитику о попытке покупки
                apiCall('POST', '/api/analytics', {
                    event: 'premium_purchase_initiated',
                    userId: telegramUserId,
                    data: { amount: premiumPrice }
                }).catch(e => console.error('Ошибка отправки аналитики:', e));

                const response = await apiCall('POST', '/api/purchase/initiate', {
                    userId: telegramUserId,
                    item: 'premium_access'
                });
                if (response.invoice_url) {
                    // Открываем ссылку на оплату Telegram Stars
                    window.Telegram.WebApp.openInvoice(response.invoice_url);
                    showMessage('Открываю окно оплаты Telegram Stars...', false);
                } else {
                    showMessage('Не удалось получить ссылку для оплаты.', true);
                }
            } catch (error) {
                showMessage(`Ошибка при инициировании покупки: ${error.message}`, true);
            }
        }


        // --- Рендеринг списка категорий на странице выбора категорий ---
        function renderCategoriesList() {
            const categoriesListDiv = document.getElementById('categoriesList');
            if (!categoriesListDiv) return; // Выходим, если элемент не найден

            categoriesListDiv.innerHTML = ''; // Очищаем список

            if (allCategories.length === 0) {
                categoriesListDiv.innerHTML = '<p class="text-red-500 text-center">Не удалось загрузить категории. Пожалуйста, убедитесь, что бэкенд запущен и доступен.</p>';
                document.getElementById('startGameBtn').disabled = true; // Отключаем кнопку, если нет категорий
                return;
            }

            allCategories.forEach(category => {
                const isPaidAndLocked = category.level === 'paid' && !isPremiumUser;
                const card = document.createElement('div');
                card.className = `card p-4 rounded-lg shadow-md flex justify-between items-center ${isPaidAndLocked ? 'disabled' : ''}`;
                card.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold">${category.name}</h3>
                        <p class="text-sm text-gray-500">${category.description}</p>
                    </div>
                    <input type="checkbox" data-category-name="${category.name}" class="form-checkbox h-6 w-6 text-purple-600 rounded-md" ${isPaidAndLocked ? 'disabled' : ''}>
                `;
                if (!isPaidAndLocked) {
                    card.addEventListener('click', () => {
                        const checkbox = card.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleCategorySelection(category.name, checkbox.checked);
                        card.classList.toggle('selected', checkbox.checked);
                    });
                }
                categoriesListDiv.appendChild(card);

                // Инициализация состояния чекбокса, если категория была выбрана ранее
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (selectedCategories.includes(category.name)) {
                    checkbox.checked = true;
                    card.classList.add('selected');
                }
            });
        }

        function toggleCategorySelection(categoryName, isSelected) {
            if (isSelected) {
                if (!selectedCategories.includes(categoryName)) {
                    selectedCategories.push(categoryName);
                }
            } else {
                selectedCategories = selectedCategories.filter(name => name !== categoryName);
            }
            console.log('Выбранные категории:', selectedCategories);
        }


        // --- Инициализация приложения ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired.');
            console.log('window.Telegram:', window.Telegram);
            if (window.Telegram) {
                console.log('window.Telegram.WebApp:', window.Telegram.WebApp);
            }

            // Инициализация Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                telegramUserId = window.Telegram.WebApp.initDataUnsafe?.user?.id?.toString();
                console.log('Telegram User ID:', telegramUserId);

                // Обработчик для успешной оплаты Telegram Stars
                window.Telegram.WebApp.onEvent('invoiceClosed', (data) => {
                    if (data.status === 'paid') {
                        showMessage('Оплата прошла успешно! Ваш премиум-доступ активирован.', false);
                        // После успешной оплаты, перепроверяем премиум-статус
                        checkPremiumStatus().then(() => {
                            renderPage('welcome'); // Обновляем страницу, чтобы показать премиум-контент
                        });
                    } else if (data.status === 'cancelled') {
                        showMessage('Оплата отменена.', true);
                    } else if (data.status === 'failed') {
                        showMessage('Ошибка оплаты. Пожалуйста, попробуйте еще раз.', true);
                    }
                });
            } else {
                console.warn('Telegram WebApp API не доступен. Некоторые функции могут быть ограничены. Для полного тестирования откройте приложение в Telegram.');
                // Для тестирования без Telegram WebApp, можно задать фейковый ID
                telegramUserId = 'test_user_123'; // Используем фейковый ID для тестирования без Telegram
            }

            // Загружаем стоимость премиум-подписки
            await fetchPremiumPrice();

            // Загружаем все задания и категории с бэкенда при старте
            const dataLoaded = await fetchTasksAndCategories();
            if (!dataLoaded) {
                // Если данные не загрузились, возможно, бэкенд не запущен.
                // Можно показать сообщение об ошибке или предложить повторить попытку.
                // Пока оставим на текущей странице (ageGate/welcome), чтобы пользователь мог увидеть ошибку.
            }

            // Проверяем статус подтверждения возраста
            const ageConfirmed = localStorage.getItem('ageConfirmed') === 'true';
            if (ageConfirmed) {
                // Если возраст подтвержден, сразу проверяем премиум-статус с бэкенда
                await checkPremiumStatus(); 
                renderPage('welcome');
            } else {
                renderPage('ageGate');
            }
        });
    </script>
</body>
</html>
